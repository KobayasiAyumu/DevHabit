/**
 * é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
 * Markdownãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§ã®é€±æ¬¡ã‚µãƒãƒªãƒ¼ç”Ÿæˆã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã‚³ãƒ”ãƒ¼ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’ç®¡ç†ã™ã‚‹
 */

const WeeklyReport = (() => {
    let currentMarkdown = '';

    /**
     * é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã®Markdownã‚’ç”Ÿæˆã™ã‚‹
     * @param {Object} data - ãƒ¬ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
     * @returns {string} Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆ
     */
    function generateMarkdown(data) {
        const lines = [];
        lines.push(`# ğŸ“Š é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆ`);
        lines.push(`**æœŸé–“**: ${data.period}`);
        lines.push('');
        lines.push(`---`);
        lines.push('');

        // ã‚µãƒãƒªãƒ¼
        lines.push(`## ğŸ¯ ä»Šé€±ã®ã‚µãƒãƒªãƒ¼`);
        lines.push('');
        lines.push(`| æŒ‡æ¨™ | å€¤ |`);
        lines.push(`|---|---|`);
        lines.push(`| ç·ã‚³ãƒŸãƒƒãƒˆæ•° | **${data.totalCommits}** |`);
        lines.push(`| ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°æ™‚é–“ | **${data.totalHours}h** |`);
        lines.push(`| é€£ç¶šã‚³ãƒŸãƒƒãƒˆæ—¥æ•° | **${data.streak}æ—¥** ğŸ”¥ |`);
        lines.push(`| ãƒ”ãƒ¼ã‚¯æ™‚é–“å¸¯ | ${data.peakHour} |`);
        lines.push(`| ä½œæ¥­BGMãƒˆãƒƒãƒ— | ${data.topGenre} ğŸµ |`);
        lines.push(`| å¹³å‡ã‚¨ãƒãƒ«ã‚®ãƒ¼ | ${data.energyAvg}% |`);
        lines.push('');

        // è¨€èªåˆ¥
        lines.push(`## ğŸ’» ä½¿ç”¨è¨€èª`);
        lines.push('');
        data.topLanguages.forEach(lang => {
            const bar = 'â–ˆ'.repeat(Math.floor(lang.percentage / 5)) + 'â–‘'.repeat(20 - Math.floor(lang.percentage / 5));
            lines.push(`- **${lang.name}** \`${bar}\` ${lang.percentage}%`);
        });
        lines.push('');

        // ãƒªãƒã‚¸ãƒˆãƒª
        lines.push(`## ğŸ“ ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒªãƒã‚¸ãƒˆãƒª`);
        lines.push('');
        data.topRepos.forEach((repo, i) => {
            const medal = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][i] || '  ';
            lines.push(`${medal} **${repo.name}** â€” ${repo.commits} commits`);
        });
        lines.push('');

        // æˆæœ
        lines.push(`## ğŸ† ä»Šé€±ã®æˆæœ`);
        lines.push('');
        data.achievements.forEach(a => {
            lines.push(`- ${a}`);
        });
        lines.push('');

        // æ”¹å–„ç‚¹
        lines.push(`## ğŸ’¡ æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ`);
        lines.push('');
        data.improvements.forEach(imp => {
            lines.push(`- ${imp}`);
        });
        lines.push('');

        lines.push(`---`);
        lines.push(`*Generated by DevHabit Dashboard*`);

        return lines.join('\n');
    }

    /**
     * Markdownã‚’HTMLã«å¤‰æ›ã™ã‚‹ï¼ˆç°¡æ˜“ãƒ‘ãƒ¼ã‚µãƒ¼ï¼‰
     * @param {string} md - Markdownæ–‡å­—åˆ—
     * @returns {string} HTMLæ–‡å­—åˆ—
     */
    function markdownToHtml(md) {
        let html = md;

        // ãƒ˜ãƒƒãƒ€ãƒ¼
        html = html.replace(/^### (.+)$/gm, '<h3>$1</h3>');
        html = html.replace(/^## (.+)$/gm, '<h2>$1</h2>');
        html = html.replace(/^# (.+)$/gm, '<h1>$1</h1>');

        // æ°´å¹³ç·š
        html = html.replace(/^---$/gm, '<hr>');

        // ãƒ†ãƒ¼ãƒ–ãƒ«
        html = html.replace(/^\|(.+)\|$/gm, (match) => {
            const cells = match.split('|').filter(c => c.trim());
            if (cells.every(c => /^[-]+$/.test(c.trim()))) {
                return ''; // åŒºåˆ‡ã‚Šè¡Œã¯ã‚¹ã‚­ãƒƒãƒ—
            }
            const row = cells.map(c => `<td>${c.trim()}</td>`).join('');
            return `<tr>${row}</tr>`;
        });
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã‚’tableã§å›²ã‚€
        html = html.replace(/((?:<tr>.+<\/tr>\n?)+)/g, '<table>$1</table>');

        // å¤ªå­—
        html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');

        // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
        html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

        // ãƒªã‚¹ãƒˆ
        html = html.replace(/^- (.+)$/gm, '<li>$1</li>');
        html = html.replace(/((?:<li>.+<\/li>\n?)+)/g, '<ul>$1</ul>');

        // æ®µè½
        html = html.replace(/^(?!<[hultdhr])(.+)$/gm, '<p>$1</p>');

        // ç©ºè¡Œã‚’å‰Šé™¤
        html = html.replace(/<p>\s*<\/p>/g, '');

        return html;
    }

    /**
     * ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦UIã«è¡¨ç¤ºã™ã‚‹
     */
    function generate() {
        const data = MockData.getWeeklyReportData();
        currentMarkdown = generateMarkdown(data);

        const previewEl = document.getElementById('report-preview');
        const rawEl = document.getElementById('report-raw');
        const placeholderEl = document.getElementById('report-placeholder');
        const footerEl = document.getElementById('report-footer');
        const copyBtn = document.getElementById('btn-copy-report');
        const downloadBtn = document.getElementById('btn-download-report');

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        previewEl.innerHTML = markdownToHtml(currentMarkdown);
        previewEl.style.display = 'block';
        rawEl.textContent = currentMarkdown;
        placeholderEl.style.display = 'none';
        footerEl.style.display = 'block';

        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        copyBtn.disabled = false;
        downloadBtn.disabled = false;

        // ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        previewEl.style.opacity = '0';
        previewEl.style.transform = 'translateY(10px)';
        requestAnimationFrame(() => {
            previewEl.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
            previewEl.style.opacity = '1';
            previewEl.style.transform = 'translateY(0)';
        });
    }

    /**
     * Markdownã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã™ã‚‹
     */
    async function copyToClipboard() {
        if (!currentMarkdown) return;
        try {
            await navigator.clipboard.writeText(currentMarkdown);
            const btn = document.getElementById('btn-copy-report');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i data-lucide="check"></i><span>ã‚³ãƒ”ãƒ¼æ¸ˆã¿ï¼</span>';
            lucide.createIcons();
            setTimeout(() => {
                btn.innerHTML = originalHTML;
                lucide.createIcons();
            }, 2000);
        } catch (err) {
            console.error('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—:', err);
        }
    }

    /**
     * Markdownãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹userAgentã«
     */
    function downloadMarkdown() {
        if (!currentMarkdown) return;
        const blob = new Blob([currentMarkdown], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `weekly-report-${new Date().toISOString().split('T')[0]}.md`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    /**
     * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨Rawè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
     */
    function toggleRawView() {
        const previewEl = document.getElementById('report-preview');
        const rawEl = document.getElementById('report-raw');
        const toggleBtn = document.getElementById('btn-toggle-raw');

        if (rawEl.style.display === 'none') {
            rawEl.style.display = 'block';
            previewEl.style.display = 'none';
            toggleBtn.innerHTML = '<i data-lucide="eye"></i><span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º</span>';
        } else {
            rawEl.style.display = 'none';
            previewEl.style.display = 'block';
            toggleBtn.innerHTML = '<i data-lucide="code-2"></i><span>Markdownè¡¨ç¤º</span>';
        }
        lucide.createIcons();
    }

    /**
     * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã™ã‚‹
     */
    function bindEvents() {
        document.getElementById('btn-generate-report').addEventListener('click', generate);
        document.getElementById('btn-copy-report').addEventListener('click', copyToClipboard);
        document.getElementById('btn-download-report').addEventListener('click', downloadMarkdown);
        document.getElementById('btn-toggle-raw').addEventListener('click', toggleRawView);
    }

    /**
     * é€±æ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–ã™ã‚‹
     */
    function init() {
        bindEvents();
    }

    return { init, generate };
})();
